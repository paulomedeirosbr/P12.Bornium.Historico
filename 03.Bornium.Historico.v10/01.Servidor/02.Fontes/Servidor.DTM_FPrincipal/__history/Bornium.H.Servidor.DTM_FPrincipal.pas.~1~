unit Bornium.H.Servidor.DTM_FPrincipal;

//##############################################################################################################################################################
//
//  Objetivo:
//
//##############################################################################################################################################################
//
//  Revisão: xx/xx/xx - Quem - O que?
//
//##############################################################################################################################################################

interface

uses
  System.SysUtils, System.Classes,
  Datasnap.DSTCPServerTransport,
  Datasnap.DSHTTPCommon, Datasnap.DSHTTP,
  Datasnap.DSServer, Datasnap.DSCommonServer,
  IPPeerServer, IPPeerAPI, Datasnap.DSAuth,
  Bornium.H.Servidor.OBJ_RegistraServerClass;

type
  TDTM_FPrincipal = class(TDataModule)
    Servidor: TDSServer;
    CMAuthManager: TDSAuthenticationManager;
    Protocolo_TCPIP: TDSTCPServerTransport;
    procedure ProtocoloTCPI_IPGetClass(DSServerClass: TDSServerClass; var PersistentClass: TPersistentClass);
    procedure DataModuleCreate(Sender: TObject);
    procedure DataModuleDestroy(Sender: TObject);
    procedure ServidorConnect(DSConnectEventObject: TDSConnectEventObject);
    procedure ServidorDisconnect(DSConnectEventObject: TDSConnectEventObject);
  private

    oRegistraServerClass : TOBJ_RegistraServerClass;

  public

    procedure Iniciar;
    procedure Parar;

    function EstaConectado :Boolean;

  end;

implementation

uses
  Geral.A07_008.OBJ_LogWin, Bornium.H.Servidor.DTM_Conexao;

{$R *.dfm}

//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

procedure TDTM_FPrincipal.DataModuleCreate(Sender: TObject);
// var   Reg :  TRegistry;
begin
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
 (*
  Reg := TRegistry.Create(KEY_READ or KEY_WRITE);
  try
    Reg.RootKey := HKEY_LOCAL_MACHINE;
    if Reg.OpenKey('\SYSTEM\CurrentControlSet\Services\' + Name, false) then begin
      Reg.WriteString('Description', 'Bornium 1.0');
      Reg.CloseKey;
    end;
  finally
    Reg.Free;
  end;
  *)
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
//  TOBJ_AdmConexao.getInstance;
  Servidor.AutoStart := False;
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
  try
//    Protocolo_TCPIP.Port:= StrToInt(TOBJ_AdmConexao.getInstance.ConfigSistema.RecInfo(TCodSistema.APP_BORNIUM, TCTE_ConfMaquinaServidor.CTE_SERVIDOR_PORTA_BORNIUM + TCTE_Geral.IdentifSistema ,'0'));
    Protocolo_TCPIP.Port:= 40000;
  except
    Protocolo_TCPIP.Port:= 0;
  end;
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
  try
    oRegistraServerClass := TOBJ_RegistraServerClass.Create(Self, Servidor);
    oRegistraServerClass.ExecRegistroClasses;
  Except
    on E : Exception do begin
      TOBJ_LogWin.Registrar(UnitName + '.' + ClassName + '.DataModuleCreate' +  E.Message)
    end;
  end;
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
end;

procedure TDTM_FPrincipal.DataModuleDestroy(Sender: TObject);
begin
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
  FreeAndNil(oRegistraServerClass);
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
end;

//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

function TDTM_FPrincipal.EstaConectado: Boolean;
begin
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
  Result:= Servidor.Started;
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
end;

//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

procedure TDTM_FPrincipal.Iniciar;
begin
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
  Servidor.Start;
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
end;

procedure TDTM_FPrincipal.Parar;
begin
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
  Servidor.Stop;
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
end;

//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

procedure TDTM_FPrincipal.ProtocoloTCPI_IPGetClass(DSServerClass: TDSServerClass; var PersistentClass: TPersistentClass);
begin
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
//  PersistentClass := TDAO_Processo;
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
end;

//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

procedure TDTM_FPrincipal.ServidorConnect(DSConnectEventObject: TDSConnectEventObject);
begin
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
  TDTM_Conexao.getInstance.ConexaoAbrir;
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
end;

procedure TDTM_FPrincipal.ServidorDisconnect(DSConnectEventObject: TDSConnectEventObject);
begin
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
  TDTM_Conexao.getInstance.ConexaoFechar;
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
end;

//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

end.

